<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">

		<meta http-equiv="Expires" content="0">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-control" content="no-cache">
		<meta http-equiv="Cache" content="no-cache">

		<title>广西普法云平台</title>
		<!-- <link rel="shortcut icon" href="content/images/favicon.ico" /> -->
		<link rel="stylesheet" href="plugins/bootstrap-3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="plugins/bootstrap-3.3.7/css/bootstrap-select.min.css">
		<link rel="stylesheet" href="content/css/custom.css">
		<link rel="stylesheet" href="content/css/layout.css">
		<link rel="stylesheet" href="content/css/style.css">
		<style type="text/css">
			body.scrollbar {
				overflow-x: hidden !important;
			}

			[data-box="exam-endbox"] {
				box-sizing: border-box !important;
				width: 100%;
				padding-top: 68px;
			}

			[data-box="exam-endbox"].width {
				padding: 0 315px;
			}

			[data-box="exam-endbox"].width.right {
				padding-right: 0;
			}

			[data-box="exam-leftbox"] {
				position: fixed;
				left: 215px;
			}

			[data-end="exercise-ending"] {
				position: absolute;
				left: 50%;
				margin-left: -35px;
			}
		</style>
	</head>
	<body class="scrollbar">
		<!-- header -->
		<div class="header" id="headerbar"></div>
		<!-- sidebar 引入左侧菜单 -->
		<div class="sidebar" id='siderBar'>
		</div>
		<!-- contents -->
		<div class="contents">
			<div class="container-fluid">
				<div class="return-back">
					<a href="javascript:;" onclick="goBack()">
						<img alt="" src="content/images/icon-arrow-left-white@20px.png" />
					</a>
				</div>
				<br />
				<div class="d-flex">
					<div class="d-block mr-md width-320">
						<div class="d-block bg-white p-md mb-md radius-sm">
							<h4 class="align-center">答题卡</h4>
							<hr />
							<div class="d-block" id="datikaDiv">
							</div>
							<div class="d-block p-sm radius-xs" style="background:#eee;">
								<div class="d-flex justify-center">
									<span class="d-flex justify-center plr-xs"><img class="mr-ns" alt="" src="content/images/img-exam-03.png" />已答题</span>
									<span class="d-flex justify-center plr-xs"><img class="mr-ns" alt="" src="content/images/img-exam-04.png" />答题中</span>
									<span class="d-flex justify-center plr-xs"><img class="mr-ns" alt="" src="content/images/img-exam-05.png" />未答</span>
								</div>
							</div>
						</div>
						<div data-card="exam-img-examing" class="d-block mb-md radius-sm">
							<div class="d-block p-xl c-white align-center">
								<h2>已答题</h2>
								<div class="exam-ing-charts">
									<div class="exam-charts">
										<h1 id="alreadySubjects"></h1>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="d-flex-item">
						<div class="d-flex justify-start bg-white p-xs radius-sm">
							<img alt="" src="content/images/icon-tags-03.png" />
							<h4 class="d-flex-item pl-md" id="examPaperName"></h4>
							<a data-toggle="right-box" class="d-block line-h-0" href="javascript:;">
								<img alt="" src="content/images/icon-toggle-rightbox@24px.png">
							</a>
						</div>
						<br />
						<div class="tabs-exercise-wrapper">
							<div class="d-block bg-white p-lg radius-sm">
								<div class="d-flex">
									<h5 class="d-flex-item pr-md">
										<span class="size-16 line-h-30" id="subjectName"></span>
										<input type="hidden" id="nowSubjectId">
										<input type="hidden" id="nowSubjectType">
									</h5>
									<span class="tags max blue" style="height:16px;" id="subjectType"></span>
								</div>
								<br />
								<div class="d-block">
									<ul data-list="answer-listview-random" data-type="0" class="exercise-answer-listview" id="subjectItems">
									</ul>
								</div>
								<div data-show="exercise-answer-tipsbox" class="d-inline mtb-xxl">
									<span class="d-flex justify-start">
										<img alt="" src="content/images/icon-tips-gray@32px.png" />
										<a class="d-block size-14" href="javascript:;">查看提醒</a>
									</span>
								</div>
								<div class="exercise-answer-tipsbox mtb-xxl d-none">
									<h3 class="align-center">提醒</h3>
									<hr />
									<p id="reminderInfo"></p>
									<h6 class="align-center">
										<a data-hide="exercise-answer-tipsbox" href="javascript:;">
											<span class="size-14 c-error">关闭</span>
										</a>
									</h6>
								</div>
							</div>
							<br />
							<div class="d-block bg-white p-lg radius-sm">
								<div data-btn-group="btn-group" class="d-inline">
									<button type="button" class="btn btn-success" id="btnConfirm">确定</button>
									<button type="button" class="btn btn-default" id="btnPrevious">上一题</button>
								</div>
								<!-- <button data-end="exercise-ending" type="button" class="btn btn-danger" id="btnPause">暂停考试</button> -->
								<button type="button" class="btn btn-danger float-right" id="btnHandPaper">交卷</button>
							</div>
						</div>
					</div>
					<div data-box="right-box" class="d-block ml-md width-340">
						<div class="d-block bg-white p-md mb-md radius-sm">
							<h4 class="align-center">准考证</h4>
							<hr />
							<p class="align-center" id="examName"></p>
							<div class="d-block align-center">
								<span class="d-inline p-xs bd-1 line-h-0">
									<img id="userIcon" alt="" src="" onerror="this.src='content/images/defaultusericon.png'" style="max-width:100px;" />
								</span>
							</div>
							<div class="d-block p-sm mt-sm bd-1 radius-sm">
								<table class="width-all line-h-24">
									<tr>
										<th class="width-80">姓名：</th>
										<td id="workerName"></td>
									</tr>
									<tr>
										<th class="width-80">性别：</th>
										<td id="workerSex"></td>
									</tr>
									<tr>
										<th class="width-80">工作单位：</th>
										<td id="workerCompany"></td>
									</tr>
									<tr>
										<th class="width-80">考试开始：</th>
										<td>
											<div class="d-flex justify-start">
												<div class="d-block">
													<div class="exam-timeing blue">
														<text class="d-block c-white" id="startDate"></text>
														<text class="d-block c-primary" id="startTime"></text>
													</div>
												</div>
												<span class="d-flex-item plr-xs align-center">
													<img class="img-responsive" alt="" src="content/images/img-exam-timeing-lines.png" />
												</span>
												<div class="d-block">
													<div class="exam-timeing red">
														<text class="d-block c-white" id="endDate"></text>
														<text class="d-block c-error" id="endTime"></text>
													</div>
												</div>
											</div>
										</td>
									</tr>
								</table>
							</div>
						</div>
					</div>
				</div>
				<br />
			</div>
		</div>
		<!-- public-modal -->
		<div data-box="public-modal-box" class="public-modal justify-center d-none">
			<div class="alert-content">
				<div class="d-block p-xl bg-white radius-md">
					<div class="align-center">
						<h4>暂停考试？</h4>
						<br />
						<h2>你还有<span class="c-error plr-md" id="modalNoAnswer"></span>题未作答</h2>
						<br />
						<div class="d-inline">
							<h4 class="d-flex justify-center p-xs bd-1 radius-sm" style="width:auto;">
								<i class="glyphicon glyphicon-time"></i>
								<span class="pl-sm" id="noanswerTime"></span>
							</h4>
							<br />
						</div>
						<br />
						<h6 class="plr-xxl">
							<button data-close="public-modal-box" type="button" id="btnConfirmPause" onclick="location.href='./exam-new.html'"
							 class="btn btn-lg btn-danger btn-block">确定</button>
						</h6>
					</div>
				</div>
				<br />
				<br />
				<br />
				<br />
				<br />
				<h6 class="align-center">
					<a data-close="public-modal-box" class="line-h-0" href="javascript:;">
						<img alt="" src="content/images/icon-public-modal-close-white@32px.png" />
					</a>
				</h6>
			</div>
		</div>
	</body>
</html>
<script type="text/javascript" src="content/js/jquery-3.0.0.js"></script>
<script type="text/javascript" src="content/js/jquery-3.0.0.min.js"></script>
<script type="text/javascript" src="plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="plugins/bootstrap-3.3.7/js/bootstrap-select.min.js"></script>
<script type="text/javascript" src="content/js/action.js"></script>
<script language="JavaScript" src="js/api.js?v=3"></script>
<script language="JavaScript" src="js/jquery.cookie.js"></script>
<script language="JavaScript" src="js/common.js?v=5"></script>
<script type="text/javascript" src="./js/loadpage.js"></script>
<script type="text/javascript" src="content/layer/layer.js"></script>
<script language="JavaScript">
document.write("<script type='text/javascript' src='./js/exam.js?currentTime=" + new Date().getTime() + "'><\/script>")
</script>
<script language="javascript">
	var ARR_ALL = []; //全部试题
	var ARR_USER_SUBJECT_CHO = []; //用户已经答题的信息subject_id
	var USER_SUBJECT_ID_AND_CHO_MAP = {}; //用户已经答题的信息subject_id和用户选项
	var currentSubjectId = 0; // 当前题id
	var currIdx = 0; //当前题下标
	var examInfoId;
	var action;
	var examQuestionIdArr = [];
	// 倒计时总数
	countDownSecond = 10800;
	// 间隔时间
	interval = 1000;
	// 定时器
	timer = null;
	// 开始时间
	startTime = null;
	// 倒计时执行次数
	executeCount = 0;

	/*显示考试题信息*/
	var itms = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'i', 'j'];
	var storeExamInfo = {
		questionDetailArr: [],
		param: {
			examId: 0,
			examPaperId: 0,
			submitId: 0,
			userIsFinish: 0,
			currentSubjectId: 0,
			singles: "",
			multis: "",
			bools: "",
			surplusSecond: 0,
			singleMap: {},
			multiMap: {},
			boolMap: {}
		}
	};
	$(document).ready(function() {
		var reqParam = getHtmlParams(location.search);
		examInfoId = reqParam["id"];
		storeExamInfo.param.examId = examInfoId;
		action = reqParam["action"];
		if (action == "start") {
			//记录日志信息
			recordLog(operationLogParam.source.PC,operationLogParam.operation.Exam, "开始考试， ID: " + examInfoId );
			var storeExamInfoStr = localStorage.getItem("exam_info_" + $.cookie("cookie_a_userId") + "_" + examInfoId);
			if (storeExamInfoStr != null) {
				storeExamInfo = JSON.parse(storeExamInfoStr);
				ARR_ALL = storeExamInfo.questionDetailArr;
				console.log("start exam ARR_ALL.length=" + ARR_ALL.length);
				// if(ARR_ALL.length != 50){
				// 	// location.href = './exam-new.html';
				// 	alert("當前瀏覽器環境導致運行異常，請聯繫管理員。");
				// 	return;
			   	// }
				setSelectedQuestionInfo(storeExamInfo);
				currentSubjectId = storeExamInfo.param.currentSubjectId;
				countDownSecond = storeExamInfo.param.surplusSecond;
				for (var i = 0; i < ARR_ALL.length; i++) {
					if (ARR_ALL[i].subjectId == currentSubjectId) {
						currIdx = i;
					}
				}
				displaySubjectInfo();
			} else {
				layer.load(1, {
					 time: 5000, 
					shade: [0.5, '#3F3F3F']
				});
				// 获取考试信息详情
				var startExamParam = getExamInfoDetail(examInfoId);
				
				if (startExamParam != null) {
					putExamQuestionIdArr(startExamParam.singles, 1);
					putExamQuestionIdArr(startExamParam.multiples, 2);
					putExamQuestionIdArr(startExamParam.booleans, 3);
					var count = startExamParam.singles.length + startExamParam.multiples.length + startExamParam.booleans.length;
					console.log("start exam count=" + count);
					// if(count != 50){
					// 	location.href = './exam-new.html';
					// 	alert("當前瀏覽器環境導致運行異常，請聯繫管理員。");
					// 	return;
					// }
					if ( examQuestionIdArr.length != count ) {
						location.href = './exam-new.html';
						alert("开始考试，當前瀏覽器環境導致運行異常，請聯繫管理員。");
						return;
					}

					var singlesStr = startExamParam.singles.join(",");
					var multiplesStr = startExamParam.multiples.join(",");
					var booleansStr = startExamParam.booleans.join(",");
					var param = {
						examId: examInfoId,
						singles: singlesStr,
						multiples: multiplesStr,
						booleans: booleansStr
					};
					/*发送开始开始信息接口*/
					callRemoteMethod(api.startExamByIdUrl, param, callBackStartExam);
				} else {
					location.href = './exam-new.html';
					alert("您好，當前瀏覽器環境導致運行異常，請聯繫管理員。");
					return;
				}
			}
			startTime = new Date().getTime();
			if (countDownSecond >= 0) {
				timer = setTimeout(countDownStart,interval);
			}
		} else {
			syncCallRemoteMethodJson(api.continueExamByIdUrl, {
				examId: examInfoId
			}, continueExam);
			// 设置继续考试的倒计时
			timer = setTimeout(countDownStart,interval);
		}
		setExamDateTime();
		callRemoteMethod(api.getUserByIdUrl, {}, getUserInfoCallBack); //获取用户基本信息
		//确认按钮，下一题事件
		$("#btnConfirm").click(function() {
			//记录日志信息
			recordLog(operationLogParam.source.PC,operationLogParam.operation.Exam, "开始考试， ID: " + examInfoId + "  当前题目，ID:" + currentSubjectId);
			clickNext();
		});
		//上一题事件
		$("#btnPrevious").click(function() {
			if (currIdx == 0) {
				return
			}
			currIdx--
			displaySubjectInfo();
		})
		$("#btnPause").click(function() {
			$('[data-box="public-modal-box"]').toggleClass('d-none');
			$("#modalNoAnswer").html($('.noanswer').length)
			//$("#noanswerTime").html('请您在' + $("#endDate").html() + ' ' + $("#endTime").html() + '前继续答完！')
			$("#noanswerTime").html('请您在倒计时结束前完成答题！')
		})
		//交卷按钮点击事件
		$("#btnHandPaper").click(function() {
			clickNext();
			if ($('.noanswer').length > 0) {
				alert("您有" + $('.noanswer').length + "未答，请答完题，再交卷!")
				return
			}
			var storeExamInfoStr = localStorage.getItem("exam_info_" + $.cookie("cookie_a_userId") + "_" + examInfoId);
			var jsonVal = JSON.parse(storeExamInfoStr);
			var singles = '',
				multis = '',
				bools = '';
				
			// 提交进行重新排序
			let orderArr = jsonVal.order
			if (orderArr !== undefined) {
				// 单选题
				for (let i=0;i<orderArr.length;i++) {
					let key = orderArr[i]
					let value = jsonVal.param.singleMap[key]
					if (value === undefined) continue
					singles += orderArr[i] + ":" + value + ','
				}
				// 多选题
				for (let i=0;i<orderArr.length;i++) {
					let key = orderArr[i]
					let value = jsonVal.param.multiMap[key]
					if (value === undefined) continue
					multis += orderArr[i] + ":" + value + ','
				}
				// 判断题
				for (let i=0;i<orderArr.length;i++) {
					let key = orderArr[i]
					let value = jsonVal.param.boolMap[key]
					if (value === undefined) continue
					bools += orderArr[i] + ":" + value + ','
				}
			}else {
				for (var key in jsonVal.param.singleMap) {
					singles += key + ':' + jsonVal.param.singleMap[key] + ',';
				}
				for (var key in jsonVal.param.multiMap) {
					multis += key + ':' + jsonVal.param.multiMap[key] + ',';
				}
				for (var key in jsonVal.param.boolMap) {
					bools += key + ':' + jsonVal.param.boolMap[key] + ','
				}
			}

			if (singles != '') {
				singles = singles.substring(0, singles.length - 1)
			}
			if (multis != '') {
				multis = multis.substring(0, multis.length - 1)
			}
			if (bools != '') {
				bools = bools.substring(0, bools.length - 1)
			}
			
			jsonVal.param.singles = singles;
			jsonVal.param.bools = bools;
			jsonVal.param.multis = multis;
			jsonVal.param.userIsFinish = 1;
			if (confirm('是否交卷!')) {
				// 提交试卷的时候, 先不删除缓存. 提交成功再删除缓存. 防止提交失败数据丢失
				// localStorage.removeItem("exam_info_" + $.cookie("cookie_a_userId") + "_" + examInfoId);
				var param = {
					'submitId': jsonVal.param.submitId,
					'examId': examInfoId,
					'examPaperId': jsonVal.param.examPaperId,
					'singles': singles,
					'booleans': bools,
					'multiples': multis
				};
				callRemoteMethod(api.userSubmitNewExamPaperUrl, param, submitCallBack);
			}
		})
	})
</script>
